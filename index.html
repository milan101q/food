<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Culinary Alchemist</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .font-lora {
            font-family: 'Lora', serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8B5CF6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="root"></div>
    <script type="module">
        // Polyfill for process.env
        window.process = {
            env: {
                // The API_KEY is injected by the execution environment.
                API_KEY: window.aistudio?.getApiKey()
            }
        };
    </script>
    <script type="text/babel" data-type="module">
        // Import from CDN
        import { GoogleGenAI } from "https://esm.run/@google/genai";

        // ========================================================================
        // --- START OF types.ts ---
        // ========================================================================
        const AppState = {
            IDLE: 'IDLE',
            ANALYZING: 'ANALYZING',
            SUGGESTING: 'SUGGESTING',
            GENERATING_RECIPE: 'GENERATING_RECIPE',
            GENERATING_IMAGE: 'GENERATING_IMAGE',
            DISPLAYING_RECIPE: 'DISPLAYING_RECIPE',
            ERROR: 'ERROR',
        };

        const Language = {
            EN: 'en',
            FA: 'fa',
        };

        // ========================================================================
        // --- END OF types.ts ---
        // ========================================================================


        // ========================================================================
        // --- START OF i18n/translations.ts ---
        // ========================================================================
        const translations = {
            en: {
                title: "Culinary Alchemist",
                subtitle: "Transform your ingredients into master dishes.",
                uploadPrompt: "Upload a photo of your ingredients",
                uploadButton: "Choose an image",
                analyzing: "Analyzing ingredients...",
                suggestionsPrompt: "Here are 5 ideas for you:",
                generatingRecipe: "Generating Recipe...",
                generatingImage: "Painting a picture of your dish...",
                startOver: "Start Over",
                error: "An unexpected error occurred. Please try again.",
                apiKeyError: "API Key Not Configured. This app is designed to run in a specific environment where an API key is securely provided. It may not function on a public website.",
                calories: "Calories",
            },
            fa: {
                title: "کیمیاگر آشپزی",
                subtitle: "مواد اولیه خود را به غذاهای استادانه تبدیل کنید.",
                uploadPrompt: "عکسی از مواد اولیه خود آپلود کنید",
                uploadButton: "انتخاب عکس",
                analyzing: "در حال تجزیه و تحلیل مواد...",
                suggestionsPrompt: "۵ ایده برای شما:",
                generatingRecipe: "در حال تولید دستور پخت...",
                generatingImage: "در حال نقاشی غذای شما...",
                startOver: "شروع مجدد",
                error: "خطای غیرمنتظره‌ای رخ داد. لطفاً دوباره تلاش کنید.",
                apiKeyError: "کلید API پیکربندی نشده است. این برنامه برای اجرا در یک محیط خاص که در آن کلید API به طور ایمن ارائه می شود، طراحی شده است. ممکن است در یک وب سایت عمومی کار نکند.",
                calories: "کالری",
            },
        };
        // ========================================================================
        // --- END OF i18n/translations.ts ---
        // ========================================================================


        // ========================================================================
        // --- START OF services/geminiService.ts ---
        // ========================================================================
        const getAiClient = () => new GoogleGenAI({ apiKey: process.env.API_KEY });

        const generateRecipe = async (imageData, mimeType, suggestionName, language) => {
            const ai = getAiClient();
            const langMap = { en: "English", fa: "Persian (Farsi)" };
            const prompt = `Analyze the ingredients in this image. Based on these ingredients, generate a detailed recipe for "${suggestionName}". The recipe should be in ${langMap[language]}. Include a creative name for the dish, a list of ingredients with quantities, and step-by-step instructions. The response must be in markdown format.`;

            const imagePart = {
                inlineData: {
                    data: imageData,
                    mimeType: mimeType,
                },
            };
            const textPart = { text: prompt };

            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: { parts: [imagePart, textPart] },
            });
            return response.text;
        };

        const generateImage = async (recipe) => {
            const ai = getAiClient();
            const prompt = `Generate a photorealistic image of the following dish, styled for a gourmet food magazine: ${recipe}`;
            
            const response = await ai.models.generateImages({
                model: 'imagen-4.0-generate-001',
                prompt: prompt,
                config: {
                    numberOfImages: 1,
                    aspectRatio: '16:9',
                },
            });
            const base64ImageBytes = response.generatedImages[0].image.imageBytes;
            return `data:image/png;base64,${base64ImageBytes}`;
        };
        // ========================================================================
        // --- END OF services/geminiService.ts ---
        // ========================================================================


        // ========================================================================
        // --- START OF components/icons.tsx ---
        // ========================================================================
        const UploadIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
          </svg>
        );
        // ========================================================================
        // --- END OF components/icons.tsx ---
        // ========================================================================


        // ========================================================================
        // --- START OF components/LanguageSelector.tsx ---
        // ========================================================================
        const LanguageSelector = ({ language, setLanguage, t }) => {
            const toggleLanguage = () => {
                const newLang = language === Language.EN ? Language.FA : Language.EN;
                setLanguage(newLang);
                document.documentElement.lang = newLang;
                document.documentElement.dir = newLang === Language.FA ? 'rtl' : 'ltr';
            };

            return (
                <div className="absolute top-4 right-4">
                    <button
                        onClick={toggleLanguage}
                        className="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-md text-white transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500"
                    >
                        {language === Language.EN ? 'فارسی' : 'English'}
                    </button>
                </div>
            );
        };
        // ========================================================================
        // --- END OF components/LanguageSelector.tsx ---
        // ========================================================================


        // ========================================================================
        // --- START OF components/ImageUploader.tsx ---
        // ========================================================================
        const ImageUploader = ({ onImageUpload, t }) => {
            const [isDragging, setIsDragging] = React.useState(false);
            const fileInputRef = React.useRef(null);

            const handleFile = (file) => {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        onImageUpload(e.target.result.split(',')[1], file.type);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleDragEnter = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(true); };
            const handleDragLeave = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(false); };
            const handleDragOver = (e) => { e.preventDefault(); e.stopPropagation(); };
            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(false);
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                    e.dataTransfer.clearData();
                }
            };

            return (
                <div
                    className={`w-full max-w-lg p-8 border-2 border-dashed rounded-xl transition-colors duration-300 ${isDragging ? 'border-purple-500 bg-gray-800' : 'border-gray-600 hover:border-purple-400'}`}
                    onDragEnter={handleDragEnter}
                    onDragLeave={handleDragLeave}
                    onDragOver={handleDragOver}
                    onDrop={handleDrop}
                >
                    <div className="text-center">
                        <h2 className="text-2xl font-semibold text-gray-200 mb-4 font-lora">{t.uploadPrompt}</h2>
                        <button
                            onClick={() => fileInputRef.current.click()}
                            className="inline-flex items-center px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500"
                        >
                            <UploadIcon />
                            {t.uploadButton}
                        </button>
                        <input
                            type="file"
                            ref={fileInputRef}
                            onChange={(e) => handleFile(e.target.files[0])}
                            className="hidden"
                            accept="image/*"
                        />
                    </div>
                </div>
            );
        };
        // ========================================================================
        // --- END OF components/ImageUploader.tsx ---
        // ========================================================================

        // ========================================================================
        // --- START OF components/RecipeSuggestions.tsx ---
        // ========================================================================
        const RecipeSuggestions = ({ suggestions, onSelect, t }) => {
             return (
                <div className="w-full max-w-3xl text-center fade-in">
                    <h2 className="text-3xl font-bold mb-6 font-lora">{t.suggestionsPrompt}</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {suggestions.map((suggestion, index) => (
                            <button
                                key={index}
                                onClick={() => onSelect(suggestion.name)}
                                className="p-6 bg-gray-800 rounded-lg text-left hover:bg-purple-800/50 border border-gray-700 hover:border-purple-500 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500"
                            >
                                <span className="text-lg font-semibold text-gray-100">{suggestion.name}</span>
                                <p className="text-sm text-gray-400 mt-2">{t.calories}: {suggestion.calories}</p>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };
        // ========================================================================
        // --- END OF components/RecipeSuggestions.tsx ---
        // ========================================================================


        // ========================================================================
        // --- START OF components/RecipeDisplay.tsx ---
        // ========================================================================
        const RecipeDisplay = ({ recipe, image, onStartOver, t }) => {
            const createMarkup = (markdown) => {
                const html = markdown
                  .replace(/^# (.*$)/gim, '<h1 class="text-3xl font-bold font-lora text-purple-300 my-4">$1</h1>')
                  .replace(/^## (.*$)/gim, '<h2 class="text-2xl font-semibold font-lora text-purple-400 mt-6 mb-3">$1</h2>')
                  .replace(/^### (.*$)/gim, '<h3 class="text-xl font-semibold font-lora mt-4 mb-2">$1</h3>')
                  .replace(/\*\*(.*)\*\*/g, '<strong>$1</strong>')
                  .replace(/\*(.*)\*/g, '<em>$1</em>')
                  .replace(/^\* (.*$)/gim, '<li class="ml-6 mb-2 flex items-start"><span class="mr-2 mt-1.5 text-purple-400">&bull;</span>$1</li>')
                  .replace(/(\r\n|\n\r|\r|\n){2,}/g, '<br/><br/>') // Handle line breaks
                  .replace(/(\r\n|\n\r|\r|\n)(?!\<li|\<h)/g, '<br/>'); // Handle single line breaks for non-list/header items
                return { __html: html.replace(/<br\/><br\/>(\<li)/g, '$1') }; // Cleanup extra breaks before lists
            };

            return (
                <div className="w-full max-w-5xl mx-auto p-4 md:p-8 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <img src={image} alt="Generated dish" className="w-full h-auto rounded-xl shadow-lg object-cover aspect-video" />
                        </div>
                        <div className="prose prose-invert max-w-none text-gray-300" dangerouslySetInnerHTML={createMarkup(recipe)}></div>
                    </div>
                     <div className="text-center mt-8">
                        <button
                            onClick={onStartOver}
                            className="px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-purple-500"
                        >
                            {t.startOver}
                        </button>
                    </div>
                </div>
            );
        };
        // ========================================================================
        // --- END OF components/RecipeDisplay.tsx ---
        // ========================================================================


        // ========================================================================
        // --- START OF App.tsx ---
        // ========================================================================
        const App = () => {
            const [appState, setAppState] = React.useState(AppState.IDLE);
            const [language, setLanguage] = React.useState(Language.EN);
            const [error, setError] = React.useState(null);
            const [imageData, setImageData] = React.useState(null);
            const [mimeType, setMimeType] = React.useState(null);
            const [suggestions, setSuggestions] = React.useState([]);
            const [recipe, setRecipe] = React.useState(null);
            const [generatedImage, setGeneratedImage] = React.useState(null);

            const t = translations[language];

            React.useEffect(() => {
                if (!process.env.API_KEY) {
                    setError(t.apiKeyError);
                    setAppState(AppState.ERROR);
                }
            }, [t.apiKeyError]);

            const handleImageUpload = async (data, type) => {
                setImageData(data);
                setMimeType(type);
                setAppState(AppState.ANALYZING);
                try {
                    const ai = getAiClient();
                    const prompt = "Analyze this image of ingredients and suggest 5 creative, distinct, and appealing recipe ideas. For each recipe, provide an estimated calorie count per serving. Respond with only a JSON array of objects. Each object must have two keys: 'name' (string) and 'calories' (string). Example: [{\"name\": \"Spicy Tomato Pasta\", \"calories\": \"approx. 550 kcal\"}]. Do not include any other text or markdown.";
                    const imagePart = { inlineData: { data, mimeType: type } };
                    
                    const response = await ai.models.generateContent({
                        model: 'gemini-2.5-flash',
                        contents: { parts: [imagePart, { text: prompt }] },
                        config: { responseMimeType: 'application/json' }
                    });
                    
                    const text = response.text.trim();
                    const parsedSuggestions = JSON.parse(text);

                    // Ensure we have exactly 5 suggestions, padding if necessary
                    while (parsedSuggestions.length < 5) {
                        parsedSuggestions.push({ name: "Creative Chef's Choice", calories: "Varies" });
                    }

                    setSuggestions(parsedSuggestions.slice(0, 5));
                    setAppState(AppState.SUGGESTING);
                } catch (err) {
                    console.error(err);
                    setError(t.error);
                    setAppState(AppState.ERROR);
                }
            };
            
            const handleSuggestionSelect = async (selectedSuggestionName) => {
                setAppState(AppState.GENERATING_RECIPE);
                 try {
                    const recipeText = await generateRecipe(imageData, mimeType, selectedSuggestionName, language);
                    setRecipe(recipeText);
                    
                    setAppState(AppState.GENERATING_IMAGE);
                    const imageUrl = await generateImage(recipeText);
                    setGeneratedImage(imageUrl);
                    
                    setAppState(AppState.DISPLAYING_RECIPE);
                } catch (err) {
                    console.error(err);
                    setError(t.error);
                    setAppState(AppState.ERROR);
                }
            };

            const resetState = () => {
                setAppState(AppState.IDLE);
                setError(null);
                setImageData(null);
                setMimeType(null);
                setSuggestions([]);
                setRecipe(null);
                setGeneratedImage(null);
                // Re-check for API key on reset if it was the initial error
                if (!process.env.API_KEY) {
                    setError(t.apiKeyError);
                    setAppState(AppState.ERROR);
                }
            };
            
            const renderContent = () => {
                switch (appState) {
                    case AppState.IDLE:
                        return <ImageUploader onImageUpload={handleImageUpload} t={t} />;
                    case AppState.ANALYZING:
                        return <div className="text-center"><div className="loader mx-auto"></div><p className="mt-4 text-xl">{t.analyzing}</p></div>;
                    case AppState.SUGGESTING:
                        return <RecipeSuggestions suggestions={suggestions} onSelect={handleSuggestionSelect} t={t} />;
                    case AppState.GENERATING_RECIPE:
                         return <div className="text-center"><div className="loader mx-auto"></div><p className="mt-4 text-xl">{t.generatingRecipe}</p></div>;
                    case AppState.GENERATING_IMAGE:
                         return <div className="text-center"><div className="loader mx-auto"></div><p className="mt-4 text-xl">{t.generatingImage}</p></div>;
                    case AppState.DISPLAYING_RECIPE:
                        return <RecipeDisplay recipe={recipe} image={generatedImage} onStartOver={resetState} t={t} />;
                    case AppState.ERROR:
                        return (
                            <div className="text-center text-yellow-300 bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg">
                                <p className="text-lg mb-4">{error}</p>
                                {error !== t.apiKeyError && (
                                     <button onClick={resetState} className="px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700">{t.startOver}</button>
                                )}
                            </div>
                        );
                    default:
                        return null;
                }
            };

            return (
                <main className="min-h-screen w-full flex flex-col items-center justify-center p-4">
                    <LanguageSelector language={language} setLanguage={setLanguage} t={t} />
                    <div className="text-center mb-12">
                         <h1 className="text-5xl md:text-6xl font-bold font-lora text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">
                            {t.title}
                        </h1>
                        <p className="text-lg text-gray-300 mt-2">{t.subtitle}</p>
                    </div>
                    <div className="w-full flex items-center justify-center">
                        {renderContent()}
                    </div>
                </main>
            );
        };
        // ========================================================================
        // --- END OF App.tsx ---
        // ========================================================================

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>